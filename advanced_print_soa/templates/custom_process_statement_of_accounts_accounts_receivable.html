<style>
	body, html {
		margin: 0;
		padding: 0;
		height: 100%;
	}
	.page-break {
        page-break-after: always;
    }
	.content {
		padding: 0px;
		min-height: calc(100% - 40px); 
		box-sizing: border-box; 
	}
	#footer {
		position: fixed;
		bottom: 0;
		left: 0;
		width: 100%;
		text-align: center;
		padding: 10px;
	}
	
	.print-format {
		padding: 0mm;
		font-size: 8.0pt !important;
	}
	.print-format td {
		vertical-align:middle !important;
	}
    .soa-title {
        font-size: 32px;
        font-weight: 600;
        color: #b3b3b3;
        letter-spacing: 2px;
        margin-bottom: 30px;
    }
    .logo-img {
        max-width: 150px;
    }
</style>

<table class="table w-100" style="font-size: 12px; line-height: 1.5;">
  <tr>
    <td class="col-8" style="vertical-align: top; padding-right: 15px;">
      <!-- Statement Title -->
      <div class="soa-title" style="font-size: 25px; color: #000; font-weight: 600; margin-bottom: 20px;">
        STATEMENT OF ACCOUNT
      </div>

      <!-- Customer Information -->
      <div class="mb-2">
        <strong>Customer Name: </strong>{{ filters.customer_name }}
      </div>

      <!-- Customer Address -->
      <div class="mb-2">
        <strong>Customer Address: </strong>
        {% set customer_address = frappe.db.get_value("Customer", filters.party, "customer_primary_address") %}
        {% set customer_address_1 = frappe.db.get_value("Address", customer_address, "address_line1") %}
        {% set customer_address_2 = frappe.db.get_value("Address", customer_address, "address_line2") %}
        {% set customer_address_city = frappe.db.get_value("Address", customer_address, "city") %}
        {% set customer_address_country = frappe.db.get_value("Address", customer_address, "country") %}
        {% set customer_address_phone = frappe.db.get_value("Address", customer_address, "phone") %}
        {% set customer_address_email = frappe.db.get_value("Address", customer_address, "email_id") %}
        <div>{{ customer_address_1 }}, {{ customer_address_2 }}, {{ customer_address_city }}, {{ customer_address_country }}</div>
      </div>

      <!-- Contact -->
      <div class="mb-2">
        <strong>Contact: </strong>{{ customer_address_phone }}
      </div>

      <!-- Email -->
      <div class="mb-2">
        <strong>Email: </strong>{{ customer_address_email }}
      </div>

      <!-- Date Range -->
      <div>
        <strong>Date: </strong>{{ frappe.format((filters.report_date), 'Date') }}
      </div>
    </td>

    <td class="col-4" style="vertical-align: top; text-align: right; padding-left: 15px;">
      <!-- Company Logo -->
      <div class="col-12 text-right">
        {% set logo_link = frappe.db.get_single_value("Advanced Print SOA Settings", "logo") %}
        <img src="{{ logo_link }}" class="img-fluid" style="max-width: 200px; max-height: 200px;"/>
      </div>
    </td>
  </tr>
</table>

{% if(filters.show_future_payments) %}
	{% set balance_row = data.slice(-1).pop() %}
	{% for i in report.columns %}
		{% if i.fieldname == 'age' %}
			{% set elem = i %}
		{% endif %}
	{% endfor %}
	{% set start = report.columns.findIndex(elem) %}
	{% set range1 = report.columns[start].label %}
	{% set range2 = report.columns[start+1].label %}
	{% set range3 = report.columns[start+2].label %}
	{% set range4 = report.columns[start+3].label %}
	{% set range5 = report.columns[start+4].label %}
	{% set range6 = report.columns[start+5].label %}

	{% if(balance_row) %}
	<table class="table table-bordered table-condensed">
		<caption class="text-right">(Amount in {{ data[0]["currency"] ~ "" }})</caption>
			<colgroup>
				<col style="width: 30mm;">
				<col style="width: 18mm;">
				<col style="width: 18mm;">
				<col style="width: 18mm;">
				<col style="width: 18mm;">
				<col style="width: 18mm;">
				<col style="width: 18mm;">
				<col style="width: 18mm;">
			</colgroup>

		<thead>
			<tr>
				<th>{{ _(" ") }}</th>
				<th>{{ _(range1) }}</th>
				<th>{{ _(range2) }}</th>
				<th>{{ _(range3) }}</th>
				<th>{{ _(range4) }}</th>
				<th>{{ _(range5) }}</th>
				<th>{{ _(range6) }}</th>
				<th>{{ _("Total") }}</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>{{ _("Total Outstanding") }}</td>
				<td class="text-right">
					{{ format_number(balance_row["age"], null, 2) }}
				</td>
				<td class="text-right">
					{{ frappe.utils.fmt_money(balance_row["range1"], data[data.length-1]["currency"]) }}
				</td>
				<td class="text-right">
					{{ frappe.utils.fmt_money(balance_row["range2"], data[data.length-1]["currency"]) }}
				</td>
				<td class="text-right">
					{{ frappe.utils.fmt_money(balance_row["range3"], data[data.length-1]["currency"]) }}
				</td>
				<td class="text-right">
					{{ frappe.utils.fmt_money(balance_row["range4"], data[data.length-1]["currency"]) }}
				</td>
				<td class="text-right">
					{{ frappe.utils.fmt_money(balance_row["range5"], data[data.length-1]["currency"]) }}
				</td>
				<td class="text-right">
					{{ frappe.utils.fmt_money(flt(balance_row["outstanding"]), data[data.length-1]["currency"]) }}
				</td>
			</tr>
				<td>{{ _("Future Payments") }}</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td class="text-right">
					{{ frappe.utils.fmt_money(flt(balance_row[("future_amount")]), data[data.length-1]["currency"]) }}
				</td>
			<tr class="cvs-footer">
				<th class="text-left">{{ _("Cheques Required") }}</th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th></th>
				<th class="text-right">
					{{ frappe.utils.fmt_money(flt(balance_row["outstanding"] - balance_row[("future_amount")]), data[data.length-1]["currency"]) }}</th>
			</tr>
		</tbody>

	</table>
	{% endif %}
{% endif %}


<table class="table table-bordered" style="font-size: 9px;">
	<thead>
		<tr>
			{% if(report.report_name == "Accounts Receivable" or report.report_name == "Accounts Payable") %}
				<th style="width: 9%">{{ _("Date") }}</th>
				<th style="width: 23%">{{ _("Details") }}</th>
				<th style="width: 15%">{{ _("CU In No / Ref") }}</th>
				<th style="width: 13%; text-align: right">{{ _("Invoiced Amount") }}</th>
				{% if not(filters.show_future_payments) %}
					<th style="width: 12%; text-align: right">{{ _("Paid Amount") }}</th>
					<th style="width: 12%; text-align: right">
						{% if report.report_name == "Accounts Receivable" %}
							{{ _('Credit Note') }}
						{% else %}
							{{ _('Debit Note') }}
						{% endif %}
					</th>
				{% endif %}
				<th style="width: 16%; text-align: right">{{ _("Outstanding Amount") }}</th>
			{% else %}
				<th style="width: 40%">
					{% if (filters.customer or filters.supplier or filters.customer_name) %}
						{{ _("Remarks")}}
					{% else %}
						{{ _("Party") }}
					{% endif %}
				</th>
				<th style="width: 15%">{{ _("Total Invoiced Amount") }}</th>
				<th style="width: 15%">{{ _("Total Paid Amount") }}</th>
				<th style="width: 15%">
					{% if report.report_name == "Accounts Receivable Summary" %}
						{{ _('Credit Note Amount') }}
					{% else %}
						{{ _('Debit Note Amount') }}
					{% endif %}
				</th>
				<th style="width: 15%">{{ _("Total Outstanding Amount") }}</th>
			{% endif %}
		</tr>
	</thead>
	{% set ns = namespace(page_no = 0) %}
	{% for i in range(data|length) %}
		{% if loop.index % 30 == 1 and not loop.first %}
			{% set ns.page_no = ns.page_no + 1 %}
			</table>
			<table width="100%" style="font-size: 10px; text-align: center;">
				<tr>
						<td>
							<h3 style="color:#DA2128; margin: 0;">{{ filters.company }}</h3>
						</td>
					</tr>
					<tr>
						<td>
							{% set footer_address = frappe.db.get_single_value("Advanced Print SOA Settings", "footer_address") %}
							{% set domain = frappe.db.get_single_value("Advanced Print SOA Settings", "domain") %}
							{% set footer_address_1 = frappe.db.get_value("Address", footer_address, "address_line1") %}
							{% set footer_address_2 = frappe.db.get_value("Address", footer_address, "address_line2") %}
							{% set footer_address_city = frappe.db.get_value("Address", footer_address, "city") %}
							{% set footer_address_country = frappe.db.get_value("Address", footer_address, "country") %}
							{% set footer_address_phone = frappe.db.get_value("Address", footer_address, "phone") %}
							{% set footer_address_email = frappe.db.get_value("Address", footer_address, "email_id") %}
							
							<span style="color:#DA2128;">Address:</span>
							{{ footer_address_1 }}, {{ footer_address_2 }}, {{ footer_address_city }}, {{ footer_address_country }}
						</td>
					</tr>
					<tr>
						<td>
							<span style="color:#DA2128;">Mobile:</span> {{ footer_address_phone }}
							<span style="color:#DA2128;">Email:</span> {{ footer_address_email }}
							{{ domain }}
						</td>
					</tr>
			</table>
			<p class="text-right">Page - {{ns.page_no}}</p>
			<p class="text-right">Please turn over ....</p>
			<div class="page-break"></div>

			<table class="table w-100" style="font-size: 12px; line-height: 1.5;">
				<tr>
					<td class="col-8" style="vertical-align: top; padding-right: 15px;">
					<!-- Statement Title -->
					<div class="soa-title" style="font-size: 25px; color: #000; font-weight: 600; margin-bottom: 20px;">
						STATEMENT OF ACCOUNT
					</div>

					<!-- Customer Information -->
					<div class="mb-2">
						<strong>Customer Name: </strong>{{ filters.party_name[0] }}
					</div>

					<!-- Customer Address -->
					<div class="mb-2">
						<strong>Customer Address: </strong>
						{% set customer_address = frappe.db.get_value("Customer", filters.party[0], "customer_primary_address") %}
						{% set customer_address_1 = frappe.db.get_value("Address", customer_address, "address_line1") %}
						{% set customer_address_2 = frappe.db.get_value("Address", customer_address, "address_line2") %}
						{% set customer_address_city = frappe.db.get_value("Address", customer_address, "city") %}
						{% set customer_address_country = frappe.db.get_value("Address", customer_address, "country") %}
						{% set customer_address_phone = frappe.db.get_value("Address", customer_address, "phone") %}
						{% set customer_address_email = frappe.db.get_value("Address", customer_address, "email_id") %}
						<div>{{ customer_address_1 }}, {{ customer_address_2 }}, {{ customer_address_city }}, {{ customer_address_country }}</div>
					</div>

					<!-- Contact -->
					<div class="mb-2">
						<strong>Contact: </strong>{{ customer_address_phone }}
					</div>

					<!-- Email -->
					<div class="mb-2">
						<strong>Email: </strong>{{ customer_address_email }}
					</div>

					<!-- Date Range -->
					<div>
						<strong>Date: </strong>{{ frappe.format(filters.from_date, 'Date') }} to {{ frappe.format(filters.to_date, 'Date') }}
					</div>
					</td>

					<td class="col-4" style="vertical-align: top; text-align: right; padding-left: 15px;">
					<!-- Company Logo -->
					<div class="col-12 text-right">
						{% set logo_link = frappe.db.get_single_value("Advanced Print SOA Settings", "logo") %}
						<img src="{{ logo_link }}" class="img-fluid" style="max-width: 200px; max-height: 200px;"/>
					</div>
					</td>
				</tr>
			</table>

			<table class="table table-bordered" style="font-size: 9px;">
				<thead>
				<tr>
					{% if(report.report_name == "Accounts Receivable" or report.report_name == "Accounts Payable") %}
						<th style="width: 9%">{{ _("Date") }}</th>
						<th style="width: 23%">{{ _("Details") }}</th>
						<th style="width: 15%">{{ _("CU In No / Ref") }}</th>
						<th style="width: 13%; text-align: right">{{ _("Invoiced Amount") }}</th>
						{% if not(filters.show_future_payments) %}
							<th style="width: 12%; text-align: right">{{ _("Paid Amount") }}</th>
							<th style="width: 12%; text-align: right">
								{% if report.report_name == "Accounts Receivable" %}
									{{ _('Credit Note') }}
								{% else %}
									{{ _('Debit Note') }}
								{% endif %}
							</th>
						{% endif %}
						<th style="width: 16%; text-align: right">{{ _("Outstanding Amount") }}</th>
					{% else %}
						<th style="width: 40%">
							{% if (filters.customer or filters.supplier or filters.customer_name) %}
								{{ _("Remarks")}}
							{% else %}
								{{ _("Party") }}
							{% endif %}
						</th>
						<th style="width: 15%">{{ _("Total Invoiced Amount") }}</th>
						<th style="width: 15%">{{ _("Total Paid Amount") }}</th>
						<th style="width: 15%">
							{% if report.report_name == "Accounts Receivable Summary" %}
								{{ _('Credit Note Amount') }}
							{% else %}
								{{ _('Debit Note Amount') }}
							{% endif %}
						</th>
						<th style="width: 15%">{{ _("Total Outstanding Amount") }}</th>
					{% endif %}
				</tr>
				</thead>
				
		{% endif %}

		<tr>
			{% if(report.report_name == "Accounts Receivable" or report.report_name == "Accounts Payable") %}
				{% if(data[i]["party"]) %}
					<td>{{ frappe.format((data[i]["posting_date"]), 'Date') }}</td>
					<!-- <td style="text-align: right">{{ data[i]["age"] }}</td> -->
					<td>
						{% if not(filters.show_future_payments) %}
						{{ data[i]["voucher_type"] }}
						{% endif %}
						{{ data[i]["voucher_no"] }}
					</td>

					{% if data[i]["voucher_type"] == "Sales Invoice" %}
						{% set ref_field = frappe.db.get_value("Advanced Print SOA Settings Details",{"ref_doctype":data[i]["voucher_type"]},"ref_field") or "" %}
						{% set cu_in_no = frappe.db.get_value("Sales Invoice",data[i]["voucher_no"],ref_field) %}
					{% elif data[i]["voucher_type"] == "Payment Entry" %}
						{% set ref_field = frappe.db.get_value("Advanced Print SOA Settings Details",{"ref_doctype":data[i]["voucher_type"]},"ref_field") or "" %}
						{% set cu_in_no = frappe.db.get_value("Payment Entry",data[i]["voucher_no"],ref_field) %}
					{% endif %}

					<td style="text-align: right">{{ cu_in_no or "" }}</td>
					<td style="text-align: right">
						{{ frappe.utils.fmt_money(data[i]["invoiced"], currency=data[i]["currency"]) }}</td>

					{% if not(filters.show_future_payments) %}
						<td style="text-align: right">
							{{ frappe.utils.fmt_money(data[i]["paid"], currency=data[i]["currency"]) }}</td>
						<td style="text-align: right">
							{{ frappe.utils.fmt_money(data[i]["credit_note"], currency=data[i]["currency"]) }}</td>
					{% endif %}
					<td style="text-align: right">
						{{ frappe.utils.fmt_money(data[i]["outstanding"], currency=data[i]["currency"]) }}</td>
				{% else %}
					<td></td>
					{% if not(filters.show_future_payments) %}
					<td></td>
					{% endif %}
					{% if(report.report_name == "Accounts Receivable" and filters.show_sales_person) %}
					<td></td>
					{% endif %}
					<td></td>
					<td style="text-align: right"><b>{{ _("Total") }}</b></td>
					<td style="text-align: right">
						{{ frappe.utils.fmt_money(data[i]["invoiced"], data[i]["currency"]) }}</td>
					{% if not(filters.show_future_payments) %}
						<td style="text-align: right">
							{{ frappe.utils.fmt_money(data[i]["paid"], currency=data[i]["currency"]) }}</td>
						<td style="text-align: right">{{ frappe.utils.fmt_money(data[i]["credit_note"], currency=data[i]["currency"]) }} </td>
					{% endif %}
					<td style="text-align: right">
						{{ frappe.utils.fmt_money(data[i]["outstanding"], currency=data[i]["currency"]) }}</td>
					{% if(filters.show_future_payments) %}
						{% if(report.report_name == "Accounts Receivable") %}
							<td style="text-align: right">
								{{ data[i]["po_no"] }}</td>
						{% endif %}
						<td style="text-align: right">{{ data[i]["future_ref"] }}</td>
						<td style="text-align: right">{{ frappe.utils.fmt_money(data[i]["future_amount"], currency=data[i]["currency"]) }}</td>
						<td style="text-align: right">{{ frappe.utils.fmt_money(data[i]["remaining_balance"], currency=data[i]["currency"]) }}</td>
					{% endif %}
				{% endif %}
			{% else %}
				{% if(data[i]["party"] or "&nbsp;") %}
					{% if not(data[i]["is_total_row"]) %}
						<td>
							{% if(not(filters.customer | filters.supplier)) %}
								{{ data[i]["party"] }}
								{% if(data[i]["customer_name"] and data[i]["customer_name"] != data[i]["party"]) %}
									<br> {{ data[i]["customer_name"] }}
								{% elif(data[i]["supplier_name"] != data[i]["party"]) %}
									<br> {{ data[i]["supplier_name"] }}
								{% endif %}
							{% endif %}
							<br>{{ _("Remarks") }}:
							{{ data[i]["remarks"] }}
						</td>
					{% else %}
						<td><b>{{ _("Total") }}</b></td>
					{% endif %}
					<td style="text-align: right">{{ frappe.utils.fmt_money(data[i]["invoiced"], currency=data[i]["currency"]) }}</td>
					<td style="text-align: right">{{ frappe.utils.fmt_money(data[i]["paid"], currency=data[i]["currency"]) }}</td>
					<td style="text-align: right">{{ frappe.utils.fmt_money(data[i]["credit_note"], currency=data[i]["currency"]) }}</td>
					<td style="text-align: right">{{ frappe.utils.fmt_money(data[i]["outstanding"], currency=data[i]["currency"]) }}</td>
				{% endif %}
			{% endif %}
		</tr>
		
	{% endfor %}
	<td></td>
	<td></td>
	<td></td>
	<td style="text-align: right"><b>{{ frappe.utils.fmt_money(data|sum(attribute="invoiced"), currency=data[0]["currency"]) }}</b></td>
	<td style="text-align: right"><b>{{ frappe.utils.fmt_money(data|sum(attribute="paid"), currency=data[0]["currency"]) }}</b></td>
	<td style="text-align: right"><b>{{ frappe.utils.fmt_money(data|sum(attribute="credit_note"), currency=data[0]["currency"]) }}</b></td>
	<td style="text-align: right"><b>{{ frappe.utils.fmt_money(data|sum(attribute="outstanding"), currency=data[0]["currency"]) }}</b></td>
</table>
{% if ageing %}
	<h4 class="text-center">{{ _("Ageing Report based on ") }} {{ ageing.ageing_based_on }}
		{{ _("up to " ) }}  {{ frappe.format(filters.report_date, 'Date')}}
	</h4>
	<table class="table table-bordered">
		<thead>
			<tr>
				<th style="width: 25%">0 - 30 Days</th>
				<th style="width: 25%">30 - 60 Days</th>
				<th style="width: 25%">60 - 90 Days</th>
				<th style="width: 25%">90 - 120 Days</th>
				<th style="width: 20%">Above 120 Days</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>{{ frappe.utils.fmt_money(ageing.range1, currency=data[0]["currency"]) }}</td>
				<td>{{ frappe.utils.fmt_money(ageing.range2, currency=data[0]["currency"]) }}</td>
				<td>{{ frappe.utils.fmt_money(ageing.range3, currency=data[0]["currency"]) }}</td>
				<td>{{ frappe.utils.fmt_money(ageing.range4, currency=data[0]["currency"]) }}</td>
				<td>{{ frappe.utils.fmt_money(ageing.range5, currency=filters.presentation_currency) }}</td>
			</tr>
		</tbody>
	</table>
{% endif %}
{% if terms_and_conditions %}
	<div>
		{{ terms_and_conditions }}
	</div>
{% endif %}

<p class="text-right text-muted">{{ _("Printed On ") }}{{ frappe.utils.now() }}</p>

<table width="100%" style="font-size: 10px; text-align: center;">
	<tr>
		<td>
			<h3 style="color:#DA2128; margin: 0;">{{ filters.company }}</h3>
		</td>
	</tr>
	<tr>
		<td>
			{% set footer_address = frappe.db.get_single_value("Advanced Print SOA Settings", "footer_address") %}
			{% set domain = frappe.db.get_single_value("Advanced Print SOA Settings", "domain") %}
			{% set footer_address_1 = frappe.db.get_value("Address", footer_address, "address_line1") %}
			{% set footer_address_2 = frappe.db.get_value("Address", footer_address, "address_line2") %}
			{% set footer_address_city = frappe.db.get_value("Address", footer_address, "city") %}
			{% set footer_address_country = frappe.db.get_value("Address", footer_address, "country") %}
			{% set footer_address_phone = frappe.db.get_value("Address", footer_address, "phone") %}
			{% set footer_address_email = frappe.db.get_value("Address", footer_address, "email_id") %}
			
			<span style="color:#DA2128;">Address:</span>
			{{ footer_address_1 }}, {{ footer_address_2 }}, {{ footer_address_city }}, {{ footer_address_country }}
		</td>
	</tr>
	<tr>
		<td>
			<span style="color:#DA2128;">Mobile:</span> {{ footer_address_phone }}
			<span style="color:#DA2128;">Email:</span> {{ footer_address_email }}
			{{ domain }}
		</td>
	</tr>
</table>
{% set ns.page_no = ns.page_no + 1 %}
<p class="text-right">Page - {{ns.page_no }}</p>




